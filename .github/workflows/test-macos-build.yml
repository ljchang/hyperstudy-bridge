name: Test macOS Build

on:
  workflow_dispatch:
    inputs:
      skip_signing:
        description: 'Skip code signing'
        required: false
        type: boolean
        default: false

env:
  CARGO_TERM_COLOR: always

jobs:
  build-macos:
    name: Build macOS (Test)
    runs-on: macos-latest
    strategy:
      matrix:
        target:
          - aarch64-apple-darwin
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri
          key: macos-${{ matrix.target }}

      - name: Install dependencies
        run: npm ci

      - name: Build Tauri App (No Signing)
        if: inputs.skip_signing || github.event.inputs.skip_signing == 'true'
        run: |
          echo "Building without code signing..."
          npm run tauri:build -- --target ${{ matrix.target }} || true

          # Even if DMG fails, the app should be built
          echo "Checking for built app..."
          find src-tauri/target -name "*.app" -type d | head -5

      - name: Build Tauri App (With Signing)
        if: ${{ !inputs.skip_signing && github.event.inputs.skip_signing != 'true' }}
        env:
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY || '-' }}
          TAURI_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY || '-' }}
        run: |
          echo "Building with ad-hoc signing..."
          npm run tauri:build -- --target ${{ matrix.target }} --config src-tauri/tauri.macos.conf.json

      - name: Find and Upload Artifacts
        run: |
          # Find the DMG
          DMG_PATH=$(find src-tauri/target -name "*.dmg" -type f | head -1)

          if [ -z "$DMG_PATH" ]; then
            echo "No DMG found, looking for .app bundle..."
            APP_PATH=$(find src-tauri/target -name "*.app" -type d | grep -v "deps" | head -1)

            if [ -n "$APP_PATH" ]; then
              echo "Found app bundle: $APP_PATH"

              # Create a zip of the app bundle for easier download
              zip -r "HyperStudy-Bridge-${{ matrix.target }}.app.zip" "$APP_PATH"
              ARTIFACT_PATH="HyperStudy-Bridge-${{ matrix.target }}.app.zip"
              echo "artifact_path=$ARTIFACT_PATH" >> $GITHUB_ENV
              echo "artifact_type=app" >> $GITHUB_ENV
            fi
          else
            echo "DMG found: $DMG_PATH"
            echo "artifact_path=$DMG_PATH" >> $GITHUB_ENV
            echo "artifact_type=dmg" >> $GITHUB_ENV
          fi

          if [ -z "${ARTIFACT_PATH}${DMG_PATH}" ]; then
            echo "No build artifacts found!"
            exit 1
          fi

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build-${{ matrix.target }}
          path: ${{ env.artifact_path }}
          retention-days: 7

      - name: Create Download Comment
        if: success()
        run: |
          echo "## ðŸŽ‰ Build Successful!"
          echo ""
          echo "### Download the test build:"
          echo "The DMG file has been uploaded as an artifact."
          echo ""
          echo "To download:"
          echo "1. Go to the [Actions tab](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
          echo "2. Scroll down to 'Artifacts'"
          echo "3. Download 'macos-dmg-${{ matrix.target }}'"
          echo ""
          echo "### Build Details:"
          echo "- Target: ${{ matrix.target }}"
          echo "- Signing: ${{ inputs.skip_signing && 'Skipped' || 'Ad-hoc' }}"
          echo "- Build Time: $(date -u +%Y-%m-%dT%H:%M:%SZ)"