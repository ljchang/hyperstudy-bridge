# TTL Pulse Generator Protocol Documentation

## Overview

The TTL (Transistor-Transistor Logic) Pulse Generator is a hardware device that generates precise digital pulses for synchronizing experimental equipment. In the HyperStudy Bridge system, it's primarily used with Adafruit RP2040-based devices to trigger events with sub-millisecond precision.

## Hardware Requirements

- **Device**: Adafruit RP2040 or compatible microcontroller
- **Connection**: USB Serial (CDC - Communications Device Class)
- **Voltage Levels**: 3.3V or 5V TTL logic levels
- **Pulse Duration**: Configurable, default 10ms
- **Latency Requirement**: <1ms from command to pulse generation

## Serial Communication Protocol

### Connection Parameters

| Parameter | Value |
|-----------|-------|
| Baud Rate | 115200 (default) |
| Data Bits | 8 |
| Stop Bits | 1 |
| Parity | None |
| Flow Control | None |

### Command Format

Commands are sent as ASCII text strings terminated with a newline character (`\n`).

#### Primary Commands

1. **PULSE [duration_ms]** - Generate a single TTL pulse
   ```
   Command: PULSE\n           (uses device default duration, initially 10ms)
   Command: PULSE 5\n         (5ms pulse, overrides default for this pulse only)
   Response: OK:Pulse sent\n
   ```
   GPIO goes HIGH immediately on command receipt. Duration parameter is parsed
   after GPIO toggle, so it adds zero latency to the critical path.

2. **SETDURATION** - Configure default pulse duration
   ```
   Command: SETDURATION 20\n  (set default to 20ms, range: 1-10000ms)
   Response: OK:Duration set to 20ms\n
   ```

3. **TIMING** - Query last pulse timing (on-device measurement)
   ```
   Command: TIMING\n
   Response: OK:Timing us:12,dur:10\n
   ```
   Reports microseconds from serial-available to GPIO toggle for the last pulse.

4. **TEST** - Connection validation
   ```
   Command: TEST\n
   Response: OK:Test successful\n
   ```

5. **VERSION** - Get firmware version
   ```
   Command: VERSION\n
   Response: OK:Version 1.4.0\n
   ```

6. **SERIAL** - Get unique board serial number
   ```
   Command: SERIAL\n
   Response: OK:Serial E6614103E72B6A2F\n
   ```

7. **LONGPULSE** - Long pulse for testing/visibility
   ```
   Command: LONGPULSE\n
   Response: OK:Long pulse sent\n
   ```

### Response Format

All responses follow the pattern:
- Success: `OK:<message>\n`
- Error: `ERROR:<message>\n`

### Device Identification

Each RP2040 board has a unique USB serial number derived from its flash chip ID.
This allows the bridge to distinguish multiple TTL devices. The serial number is
auto-generated by TinyUSB — no per-device configuration needed.

## Implementation Details

### Software Architecture

```rust
pub struct TtlDevice {
    port: Option<Mutex<Box<dyn SerialPort>>>,
    port_name: String,
    status: DeviceStatus,
    config: TtlConfig,
    performance_callback: Option<PerformanceCallback>,
}
```

### Connection Flow

1. **Discovery**: Enumerate available serial ports
2. **Connection**: Open serial port with specified parameters
3. **Initialization**: Clear buffers and verify device responds
4. **Ready State**: Device ready to receive commands

### Command Execution Flow

```mermaid
sequenceDiagram
    participant App as HyperStudy App
    participant Bridge as Bridge Server
    participant TTL as TTL Device

    App->>Bridge: WebSocket: {device: "ttl", action: "send", payload: {command: "PULSE"}, id: "req-123"}
    Bridge->>TTL: Serial: PULSE 10\n
    Note over TTL: GPIO HIGH immediately, then LOW after 10ms
    TTL->>Bridge: Serial: OK:Pulse sent\n
    Bridge->>App: WebSocket: {type: "data", device: "ttl", id: "req-123", latency: 0.8ms}
```

### Performance Monitoring

The TTL module includes built-in performance monitoring to ensure sub-millisecond latency requirements are met:

```rust
pub fn set_performance_callback<F>(&mut self, callback: F)
where
    F: Fn(&str, Duration, u64, u64) + Send + Sync + 'static
```

Metrics tracked:
- **Command Latency**: Time from send() call to completion
- **Bytes Sent**: Number of bytes transmitted
- **Bytes Received**: Number of bytes in response
- **Success Rate**: Percentage of successful commands

## Error Handling

### Common Error Conditions

| Error Code | Description | Recovery Action |
|------------|-------------|-----------------|
| `NotConnected` | Device not connected | Call connect() first |
| `SerialError` | Serial port error | Check port availability |
| `CommunicationError` | Read/write failure | Retry or reconnect |
| `Timeout` | No response within 100ms | Check device power/connection |
| `InvalidPort` | Port doesn't exist | Verify port name |

### Reconnection Strategy

1. **Automatic Retry**: 3 attempts with exponential backoff
2. **Backoff Schedule**: 100ms, 500ms, 1000ms
3. **Status Updates**: Bridge notifies clients of connection status changes

## Testing

### Unit Tests

Located in `src-tauri/src/devices/ttl_tests.rs`

- Configuration validation
- Connection state management
- Error handling
- Performance callback verification

### Integration Tests

Requires physical hardware or mock serial port:

```bash
# Run with hardware connected
cargo test --features integration-tests -- --ignored

# Run specific TTL tests
cargo test ttl_tests --features integration-tests
```

### Performance Benchmarks

```bash
# Run performance benchmarks
cargo bench --bench ttl_performance
```

Expected results:
- Command latency: <1ms (99th percentile)
- Throughput: >100 commands/second
- Memory usage: <1MB per device connection

## Firmware Requirements

The microcontroller firmware must implement:

1. **USB CDC Serial Interface**: Standard serial communication
2. **Command Parser**: ASCII command interpretation
3. **GPIO Control**: TTL pulse generation on output pin
4. **Timing Precision**: Microsecond-accurate pulse duration
5. **Buffer Management**: Handle rapid command sequences

See the [hyperstudy-ttl](https://github.com/ljchang/hyperstudy-ttl) repository for the production firmware (PlatformIO-based, v1.4.0+).

Key firmware features:
- **Zero polling delay**: No `delay()` in main loop — tight polling for minimum latency
- **On-device timing**: `micros()` measurement from serial-available to GPIO toggle
- **Configurable pulse duration**: Via `PULSE <ms>` inline or `SETDURATION <ms>` command
- **Unique serial numbers**: Auto-generated from RP2040 flash chip ID

## WebSocket Bridge Integration

### Command Structure

```json
{
    "type": "command",
    "device": "ttl",
    "action": "send",
    "payload": {
        "command": "PULSE"
    },
    "id": "req-123"
}
```

### Response Structure

```json
{
    "type": "data",
    "device": "ttl",
    "id": "req-123",
    "payload": {
        "success": true,
        "latency_ms": 0.8
    },
    "timestamp": 1699123456789
}
```

## Security Considerations

1. **Local Only**: Serial ports are local hardware, no network exposure
2. **Input Validation**: All commands validated before transmission
3. **Rate Limiting**: Maximum 1000 commands/second to prevent abuse
4. **Error Isolation**: Serial errors don't affect other devices

## Troubleshooting

### Device Not Found

1. Check USB cable connection
2. Verify device appears in system:
   - macOS: `ls /dev/tty.*`
   - Linux: `ls /dev/ttyUSB*` or `ls /dev/ttyACM*`
   - Windows: Device Manager → Ports (COM & LPT)

### Permission Denied

**Linux/macOS**:
```bash
# Add user to dialout group (Linux)
sudo usermod -a -G dialout $USER

# Set port permissions (temporary)
sudo chmod 666 /dev/ttyUSB0
```

### High Latency

1. Check USB hub - connect directly to computer
2. Disable power management for USB ports
3. Verify no other applications using the port
4. Check system load and CPU throttling

## Future Enhancements

1. **Batch Commands**: Send multiple pulses with precise timing
2. **Pattern Generation**: Programmable pulse sequences
3. **Multi-Channel**: Support multiple TTL outputs
4. **Hardware Triggering**: External trigger input support
5. **Pulse Width Modulation**: Variable duty cycle support

## References

- [USB CDC Class Specification](https://www.usb.org/document-library/class-definitions-communication-devices-12)
- [RS-232 Serial Communication](https://en.wikipedia.org/wiki/RS-232)
- [TTL Logic Levels](https://en.wikipedia.org/wiki/Transistor%E2%80%93transistor_logic)
- [Adafruit RP2040 Documentation](https://learn.adafruit.com/adafruit-feather-rp2040-pico)